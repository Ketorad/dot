#!/bin/bash
# Mount or unmount fileserver via sshfs


timeout=10


start() {
	user="eivind"
	serverLocal="eivind-server"
	serverLocalIP="192.168.1.3"
	serverRemote="ketorad.com"
	serverFound=""

	while ! [[ $serverFound ]]; do
		if [[ $(ssh-keyscan $serverLocal 2>&1 | grep "#" | head -n1) ]]; then
			serverFound=$serverLocal
		elif [[ $(ssh-keyscan $serverLocalIP 2>&1 | grep "#" | head -n1) ]];then
			serverFound=$serverLocalIP
		elif [[ $(ssh-keyscan $serverRemote 2>&1 | grep "#" | head -n1) ]];then
			serverFound=$serverRemote
		else
			sleep 30
		fi
	done

	notify-send "Connected to filserver at $serverFound."

	sshfs $user@$serverFound:/media/filserver /media/filserver -f -o "uid=1000,gid=1000,idmap=user,allow_other,ServerAliveInterval=$timeout,serverAliveCountMax=1"
	notify-send "Disconnected from filserver."
}


stop() {
	if [[ $(cat /proc/mounts | grep "/media/filserver") ]]; then
		notify-send "Unmounting fileserver"
		fusermount -u /media/filserver
	fi
}


case $1 in
	start|stop) "$1" ;;
esac
